#!/bin/sh -ux
# install needed modules for usb and the ext3 filesystem
# **NOTE** for usb2.0 replace "uhci" with "ehci-hcd"
# **NOTE** for ohci chipsets replace "uhci" with "usb-ohci"
for module in usbcore uhci usb-ohci scsi_mod sd_mod usb-storage jbd ext2 ext3 ; do {
        insmod $module
}; done
# this may need to be higher if your disk is slow to initialize
sleep 3s

mnt_prefix="/mnt/linux"

root_part='';
ri=1
for part in `fdisk -l |grep 'Linux$'|cut -d ' ' -f 1`
  do
  mkdir -p "$mnt_prefix$ri"
  mount "$part" "$mnt_prefix$ri"
  test -x "$mnt_prefix$ri/sbin/init" &&
    root_part="$mnt_prefix$ri"
  ri="`expr $ri + 1`"
  done

test -n "$root_part" &&
  {
  mount --move /proc "$root_part/proc" &&
  pivot_root /mnt "$root_part/mnt" &&
    {
    mount --move "$root_part/dev"  /dev
    mount --move "$root_part/tmp"  /tmp
    mount --move "$root_part/jffs" /jffs 2>&-
    mount --move "$root_part/sys"  /sys 2>&-
    }
  }
